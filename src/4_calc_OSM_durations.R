# Connor Lydon (4 to 66)
# Joshua Anderson (68 to 190)

# loading packages and s3 keys #
library(here)
library(tidyverse)
library(sf)
library(aws.s3)
library(magrittr)
library(sf)
library(aws.s3)
library(here)
library(tidyr)
library(purrr)
library(osrm)
library(units)
library(data.table)
library(tmap)
library(ggplot2)
library(scales)

source(here::here("src", "s3_scripts", "s3_secret.r"))

download_path <- here::here("data", "temp")
b <- "vulnerabilityfidtogo"

# load capitol and adm3 data
capitol_loc <- data.frame(
  Name_1 = c("Centrale", "Kara", "Maritime"),
  ID = c("Sokode", "Kara", "Lome"),
  Y = c(8.98333, 9.55111, 6.12874),
  X = c(1.13333, 1.18611, 1.22154)
)

capitol_loc <- data.frame(
  Name_1 = c("Centrale", "Kara", "Maritime"), "Plateaux", "Savanes"),
ID = c("Sokode", "Kara", "Lome", "Atakpame", "Dapaong"),
Y = c(8.98333, 9.55111, 6.12874, 7.53333, 10.86225),
X = c(1.13333, 1.18611, 1.22154, 1.13333, 0.20762)
)

tgo_shp_path <- here::here("data", "tgo.geojson")

tgo_shp <-  st_read(tgo_shp_path)


#tgo_shp <- s3read_using(st_read, object = "Clean_Data/Spatial_Data/TGO/Raster/tgo.geojson", 
#                        bucket = b)

# determine the adm1 district for each point
tgo_adm1 <- tgo_shp %>% group_by(NAME_1) %>% dplyr::summarise()



osm_fixed <- s3read_using(st_read, bucket = b,
                          object = "Clean_Data/Spatial_Data/TGO/Raster/tgo_candidate_fixed_sites.geojson")

osm_mobile <- s3read_using(st_read, bucket = b,
                           object = "Clean_Data/Spatial_Data/TGO/Raster/tgo_candidate_mobile_sites.geojson")

tgo_candidate_sites_clean <- rbindlist(list(osm_fixed, osm_mobile), fill = T) %>%
  select(-geometry)

osm_points <- osm_fixed %>%
  mutate(fixed = 1) %>%
  rbind(osm_mobile %>%
          mutate(n_cell = NA, fixed = 0)) %>%
  st_join(st_buffer(tgo_adm1, set_units(0.02, degree))) %>% 
  st_centroid() %>%
  distinct(id, building, NAME_1, fixed, geometry) %>%
  mutate(building = tolower(building))

### get osm travel time (seconds) ###
get_dist_df <- function(adm1, points, destinations) {
  print(paste("Calculating", adm1))
  
  # nested function to calc dist with less than 100 destination points
  # function accounts for more than 100 source points
  osrm_dist <- function(points, destinations) {
    # if points exceeds 100, divide into parts
    if(nrow(points) > 100) {
      points_lst <- list()
      niter <- ceiling(nrow(points) / 100)
      
      # slice into batches of 100 and caluclate distances for each batch
      print("Progress: 0%")
      lower <- 1
      for(i in 1:niter) {
        upper <- ifelse(lower + 99 > nrow(points), nrow(points), lower + 99)
        
        points_sub <- points %>% slice(lower:upper)
        
        # osrmTable limited to 100x100 matrix
        points_lst[[i]] <- osrmTable(src = points_sub %>% select(ID, X, Y),
                                     dst = destinations %>% select(ID, X, Y),
                                     measure = "duration")$durations %>%
          as.data.frame()
        
        points_lst[[i]]$SSID <- rownames(points_lst[[i]])
        
        print(paste0("Progress: ", round(i/niter,2)*100, "%"))
        lower <- upper + 1
        Sys.sleep(0.5) # pause system for 0.5s to avoid overloading osrm server
      }
      
      # concatinate batches
      dist <- rbindlist(points_lst)
    }
    # if less than 100 points
    else {
      # calculate all points directly
      dist <- osrmTable(src = points %>% select(ID, X, Y),
                        dst = destinations %>% select(ID, X, Y),
                        measure = "duration")$durations %>%
        as.data.frame()
      
      dist$SSID <- rownames(dist)
    }
    return(dist)
  }
  
  if(nrow(destinations) > 100) {
    dest_list <- list()
    niter <- ceiling(nrow(destinations) / 100)
    
    lower <- 1
    for(i in 1:niter) {
      upper <- ifelse(lower + 99 > nrow(destinations), nrow(destinations), lower + 99)
      print(paste0("Calculating destination batch ", i, "/", niter))
      
      dest_sub <- destinations %>% slice(lower:upper)
      dest_list[[i]] <- osrm_dist(points, dest_sub)
      
      lower <- upper + 1
      Sys.sleep(0.5) # pause system for 0.5s to avoid overloading osrm server
    }
    
    result <- Reduce(merge, dest_list)
    return(result)
  }
  
  else {
    return(osrm_dist(points, destinations))
  }
  
  
}

get_captiols <- function(adm1) {
  capitol_loc %>% filter(Name_1 == adm1) %>% select(ID, X, Y)
}

# nest each set of points into its respective district
ID <- osm_points$id
NAME_1 <- osm_points$NAME_1
osm_coords_nest <- osm_points %>%
  st_coordinates() %>%
  as.data.frame() %>%
  cbind(ID) %>%
  cbind(NAME_1) %>%
  group_by(NAME_1) %>%
  nest()

# calculate osm buildings to capitol
osm_coords_nest %<>%
  mutate(capitols = map(NAME_1, get_captiols)) %>%
  mutate(durations = pmap(list(adm1 = NAME_1, points = data, destinations = capitols), 
                          get_dist_df)) %>%
  mutate(durations = map(durations, function(x) {
    names(x)[1] <- "capitol_dist"
    x
  }))

osm_candidates <- osm_coords_nest %>%
  unnest(c(data, durations)) %>%
  select(ID, NAME_1, X, Y, capitol_dist) %>%
  st_as_sf(coords = c("X", "Y"), crs = 4326) %>% 
  st_join(tgo_shp) %>% 
  left_join(tgo_candidate_sites_clean, by = c("ID" = "id")) %>%
  as.data.frame() %>%
  select(c(ID, SSID, NAME_1.x, NAME_3, capitol_dist, RIWI, POPULATION, building)) %>%
  distinct_all()

# calculate adm3 centroids to capitol
centroids <- tgo_shp %>% 
  st_centroid() %>%
  group_by(NAME_1) %>%
  nest()

centroids %<>%
  mutate(data = map(data, function(x) {
    ID <- x$SSID
    x %>% st_coordinates() %>% as.data.frame() %>% cbind(ID)
  })) %>%
  mutate(capitols = map(NAME_1, get_captiols))

centroid_dist <- centroids %>%
  mutate(durations = pmap(list(adm1 = NAME_1, points = data, destinations = capitols), 
                          get_dist_df)) %>%
  mutate(durations = map(durations, function(x) {
    names(x)[1] <- "capitol_dist"
    x
  }))

# unnest centroid distances and join to original data
tgo_centroids <- centroid_dist %>%
  select(NAME_1, durations) %>%
  unnest() %>%
  right_join(tgo_shp) %>%
  st_as_sf()

# convert capitols into geometries
capitol_sf <- st_as_sf(capitol_loc,
                       coords = c("X", "Y"),
                       crs = 4326)

# distances between adm3 centroids and osm buildings
osm_and_centroid_nest <- osm_coords_nest %>%
  inner_join(centroids, by="NAME_1") %>%
  rename("osm_buildings" = "data.x", 
         "centroids" = "data.y") %>%
  select(NAME_1, osm_buildings, centroids) %>%
  mutate(durations = pmap(list(NAME_1, centroids, osm_buildings), get_dist_df))

# send centroid to OSM distances to s3
map2(osm_and_centroid_nest$NAME_1, osm_and_centroid_nest$durations, function(adm1, data) {
  s3write_using(data, write.csv, 
                object = paste0("Clean_Data/Spatial_Data/TGO/Vector/", adm1, 
                                "_travel_centroid_to_osm.csv"),
                bucket = b)
})
### Plots
# maps of durations of centroids to capitols
tm_shape(tgo_centroids) +
  tm_polygons(col = "capitol_dist", palette = "-viridis",
              title = "Travel Time to Admin 1 Capitol\n(minutes)", title.size = 1) + 
  tm_shape(capitol_sf) +
  tm_bubbles(size = 0.2, col = "red", title.size = 5) +
  tm_layout(legend.title.size = 1.5, legend.outside = TRUE) 
names(tgo_centroids)

# scatter of travel time to capitol vs RIWI
# osm labels
ggplot(osm_candidates, aes(x = capitol_dist, y = log(RIWI), color = NAME_1.x, size = POPULATION)) +
  geom_point(alpha = 0.5) +
  labs(x = "Travel Time to Admin 1 Capitol (minutes)", 
       y = "log(Relative Impoverished Wealth Index)",
       title = paste0("Travel Time of Candidate Registration Sites to Capitol\n",
                      "vs. Relative Impoverished Wealth Index"),
       color = "Admin 1 Name",
       size = "Population") +
  scale_size_continuous(label=comma) +
  facet_wrap(~NAME_1.x) + 
  geom_text(aes(label=building),hjust=0.5, vjust=-1, check_overlap = T, size = 3) + 
  theme_bw()

# adm3 labels
ggplot(osm_candidates, aes(x = capitol_dist, y = log(RIWI), color = NAME_1.x, size = POPULATION)) +
  geom_point(alpha = 0.5) +
  labs(x = "Travel Time to Admin 1 Capitol (minutes)", 
       y = "log(Relative Impoverished Wealth Index)",
       title = paste0("Travel Time of Candidate Registration Sites to Capitol\n",
                      "vs. Relative Impoverished Wealth Index"),
       color = "Admin 1 Name",
       size = "Population") +
  geom_text(aes(label=NAME_3),hjust=0.5, vjust=-1, check_overlap = T, size = 3) + 
  scale_size_continuous(label=comma) +
  facet_wrap(~NAME_1.x) + 
  theme_bw()

ggplot(osm_points, aes(reorder(building, building, function(x) length(x)), fill=as.factor(fixed))) +
  geom_bar() +
  coord_flip() +
  labs(x = "Type of Building", y = "Frequency", fill = "Candidate Type") +
  scale_fill_discrete(labels=c("Mobile", "Fixed")) +
  theme_bw() +
  theme(legend.position = c(0.77, 0.25))

tm_shape(tgo_adm1) +
  tm_polygons() +
  tm_shape(osm_points) +
  tm_bubbles(col="NAME_1", size=0.05, title.col = "Admin 1 Name", sizes.legend = c(5,5,5,5,5)) +
  tm_layout(legend.outside = T, 
            legend.text.size = 1,
            legend.title.size = 1.5)


