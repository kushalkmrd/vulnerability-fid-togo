library(here)
library(tidyverse)
library(sf)
library(aws.s3)
library(tidyr)
library(purrr)
library(units)
library(spatialEco)
library(data.table)
library(tmap)
library(ggplot2)


source(here::here("src", "s3_scripts", "s3_secret.r"))
source(here::here("src", "opencellid_key.r"))


Sys.setenv("AWS_ACCESS_KEY_ID" = "mykey",
           "AWS_SECRET_ACCESS_KEY" = "mysecretkey",
           "AWS_DEFAULT_REGION" = "us-east-1",
           "AWS_SESSION_TOKEN" = "mytoken")

opencellid_key="pk.e91ef705a7136bcdb83192451c210803"

download_path <- here::here("data", "temp")

b <- "vulnerabilityfidtogo"

tgo_shp_path <- here::here("data", "tgo.geojson")

tgo_shp <-  st_read(tgo_shp_path)

#tgo_shp <- s3read_using(st_read, bucket=b,
#                        object="Clean_Data/Spatial_Data/TGO/Raster/tgo.geojson")

url <- paste0("https://opencellid.org/ocid/downloads?token=", opencellid_key,
              "&type=mcc&file=615.csv.gz")
download.file(url, destfile = here("data", "temp", "tgo_cell.csv"))

# net == 1 -> TogoCell
# net == 3 -> Moov
tgo_cell <- read.csv(here("data", "temp", "tgo_cell.csv"))

tgo_cell_sf <- tgo_cell %>%
  st_as_sf(coords = c("lon", "lat"),crs = 4326) %>%
  select(cell, net, range, geometry) %>%
  geo.buffer(r = 2000, sf = T)

osm_c_path <- here::here("data", "tgo_clean_candidate_sites.geojson")
osm_candidates <-  st_read(osm_c_path)


tgo_settlement <- read.csv(here("data", "tgo_settlement_20210420.csv"))
tgo_settlement <- tgo_settlement %>%
  rename(NAME=Ã¯..NAME) %>%
  mutate(id = row_number())


tgo_settlement_sf <- tgo_settlement %>%
  st_as_sf(coords = c("LONG", "LAT"),crs = 4326) %>%
  select(id, NAME, ADM3_PCODE,ADM2_PCODE, ADM1_PCODE, popPlace1, ADM3_FR, ADM2_FR, geometry)

#osm_candidates <- s3read_using(st_read, bucket = b,
#                               object = "Clean_Data/Spatial_Data/TGO/Raster/tgo_clean_candidate_sites.geojson")

join <- tgo_settlement_sf %>%
  st_centroid() %>%
  st_join(tgo_cell_sf) 


osm_no_cell_new <- join %>% 
  filter(is.na(cell)) %>% 
  select(id, NAME, popPlace1,ADM3_PCODE)

osm_cell_new <- join %>% filter(!is.na(cell)) %>%
  group_by(id) %>%
  summarise(NAME = max(NAME), 
            popPlace1 = max(popPlace1),
            ADM3_PCODE= max(ADM3_PCODE),
            n_cell = n())



join_1 <- osm_candidates %>%
  st_centroid() %>%
  st_join(tgo_cell_sf) 

osm_no_cell_old <- join_1 %>% 
  filter(is.na(cell)) %>% 
  select(id, building, raw_building_tag)

osm_cell_old <- join_1 %>% filter(!is.na(cell)) %>%
  group_by(id) %>%
  summarise(building = max(building), 
            raw_building_tag = max(raw_building_tag),
            n_cell = n())

st_write(osm_no_cell_old, here::here("data", "tgo_candidate_mobile_sites_old.geojson"),update=TRUE)
st_write(osm_cell_old, here::here("data", "tgo_candidate_fixed_sites_old.geojson"),update=TRUE)

st_write(osm_no_cell_new, here::here("data", "tgo_candidate_mobile_sites_pops.geojson"),update=TRUE)
st_write(osm_cell_new, here::here("data", "tgo_candidate_fixed_sites_pops.geojson"),update=TRUE)

osm_fixed <- osm_cell_old
osm_mobile <- osm_no_cell_old

#s3write_using(osm_no_cell, st_write, bucket = b,
#              object = "Clean_Data/Spatial_Data/TGO/Raster/tgo_candidate_mobile_sites.geojson")
#s3write_using(osm_cell, st_write, bucket = b,
#              object = "Clean_Data/Spatial_Data/TGO/Raster/tgo_candidate_fixed_sites.geojson")


tgo_cell_old <- osm_cell_old %>%
  st_join(tgo_shp) %>% 
  select(id, building, raw_building_tag, ADM_3)

tgo_no_cell_old <- osm_no_cell_old %>%
  st_join(tgo_shp) %>% 
  select(id, building, raw_building_tag, ADM_3)

tgo_cell_new <- osm_cell_new %>%
  st_join(tgo_shp) %>% 
  select(id, NAME, popPlace1,  ADM_3)

tgo_no_cell_new <- osm_no_cell_new %>%
  st_join(tgo_shp) %>% 
  select(id,  NAME, popPlace1,  ADM_3)


tgo_fixed_old <- tgo_shp %>%
  st_join(tgo_cell_old) %>%
  st_join(tgo_no_cell_old)


tgo_cell_old <- osm_cell_old %>%
  st_join(tgo_shp) %>% 
  group_by(ADM_3) %>%
  summarize(osm_fixed_count = n()) %>%
  as.data.frame() %>%
  select(-geometry)

tgo_no_cell_old <- osm_no_cell_old %>%
  st_join(tgo_shp) %>% 
  group_by(ADM_3) %>%
  summarize(osm_none_fixed_count = n()) %>%
  as.data.frame() %>%
  select(-geometry)

tgo_fixed_old <- tgo_shp %>%
  left_join(tgo_cell_old) %>%
  left_join(tgo_no_cell_old)

tgo_fixed_old <- tgo_fixed_old %>% 
  rowwise() %>% 
  mutate(total_count = sum(osm_fixed_count, osm_none_fixed_count, na.rm = TRUE)) %>%
  mutate(to_merge = if_else(total_count==0,1,0))


tgo_cell_new <- tgo_settle_center_cell %>%
  st_join(tgo_shp) %>% 
  group_by(ADM_3) %>%
  summarize(osm_fixed_count = n()) %>%
  as.data.frame() %>%
  select(-geometry)

tgo_no_cell_new <- tgo_settle_center_no_cell %>%
  st_join(tgo_shp) %>% 
  group_by(ADM_3) %>%
  summarize(osm_none_fixed_count = n()) %>%
  as.data.frame() %>%
  select(-geometry)

tgo_fixed_new <- tgo_shp %>%
  left_join(tgo_cell_new) %>%
  left_join(tgo_no_cell_new)

tgo_fixed_new <- tgo_fixed_new %>% 
  rowwise() %>% 
  mutate(total_count = sum(osm_fixed_count, osm_none_fixed_count, na.rm = TRUE)) %>%
  mutate(to_merge = if_else(total_count==0,1,0))


sum(tgo_fixed_old$to_merge)

sum(tgo_fixed_new$to_merge)

tgo_adm3_no_center <- tgo_fixed_old %>%
  filter(to_merge ==1) %>%
  select(ADM_3,geometry)

#osm_cell_new <- osm_cell_new %>%
#  rename(ADM_3=ADM3_PCODE)

#osm_no_cell_new <- osm_no_cell_new %>%
#  rename(ADM_3=ADM3_PCODE)



tgo_settle_center_cell <- tgo_adm3_no_center %>%
  st_join(osm_cell_new,left=FALSE)

tgo_settle_center_no_cell <- tgo_adm3_no_center %>%
  st_join(osm_no_cell_new,left=FALSE)

  st_join()



length(unique(tgo_cell_old$ADM_3))
length(unique(tgo_no_cell_old$ADM_3))
length(unique(tgo_cell_new$ADM_3))
length(unique(tgo_no_cell_new$ADM_3))
  


tgo_fixed_old  %>% 
  replace(is.na(.), 0) %>% 
  mutate(total_count = rowSums(select(.,osm_fixed_count,osm_none_fixed_count)))
  

'
tgo_cell <- osm_cell %>%
  st_join(tgo_shp) %>% 
  group_by(ADM_3) %>%
  summarize(osm_fixed_count = n()) %>%
  as.data.frame() %>%
  select(-geometry)

tgo_no_cell <- osm_no_cell %>%
  st_join(tgo_shp) %>% 
  group_by(ADM_3) %>%
  summarize(osm_none_fixed_count = n()) %>%
  as.data.frame() %>%
  select(-geometry)

tgo_fixed <- tgo_shp %>%
  left_join(tgo_cell) %>%
  left_join(tgo_no_cell)

tm_shape(tgo_fixed) +
  tm_polygons(col = "osm_fixed_count", palette = "viridis", textNA = "None", 
              breaks = c(1, 21, 51, 71, 101, 201, 301, 900), 
              title = "Number of Candidate Sites\nwithin Range of Cell Tower") +
  tm_layout(legend.outside = T)

tm_shape(tgo_fixed) +
  tm_polygons(col = "osm_fixed_count", style = "log10_pretty", palette = "viridis", textNA = "None", 
              title = "Log of Number of Candidate Sites\nwithin 2km of a Cell Tower") +
  tm_layout(legend.outside = T)

tm_shape(tgo_fixed) +
  tm_polygons(col = "osm_none_fixed_count", style = "log10_pretty", palette = "viridis", textNA = "None", 
              title = "Log of Number of Candidate Sites\nnot within 2km of a Cell Tower") +
  tm_layout(legend.outside = T)

tgo_adm1 <- tgo_shp %>% group_by(ADM_1) %>% summarise()
tm_shape(tgo_adm1) +
  tm_polygons() +
  tm_shape(tgo_cell_sf %>% mutate(net = as.factor(net))) +
  tm_dots(col = "net", palette = "Set1", 
          title = "Carrier", size = 0.1,
          labels = c("TogoCell", "Moov")) +
  tm_layout(legend.outside = T, 
            legend.text.size = 1.5,
            legend.title.size = 2)
  
tgo_cell_sf %>% group_by(net) %>% summarise(count = n())
tmaptools::palette_explorer()'''

